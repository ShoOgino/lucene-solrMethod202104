  private synchronized final void finishCommit() throws IOException {

    if (pendingCommit != null) {
      try {
        if (infoStream.isEnabled("IW")) {
          infoStream.message("IW", "commit: pendingCommit != null");
        }
        pendingCommit.finishCommit(directory);
        if (infoStream.isEnabled("IW")) {
          infoStream.message("IW", "commit: wrote segments file \"" + pendingCommit.getSegmentsFileName() + "\"");
        }
        segmentInfos.updateGeneration(pendingCommit);
        lastCommitChangeCount = pendingCommitChangeCount;
        rollbackSegments = pendingCommit.createBackupSegmentInfos();
        // NOTE: don't use this.checkpoint() here, because
        // we do not want to increment changeCount:
        deleter.checkpoint(pendingCommit, true);
      } finally {
        // Matches the incRef done in prepareCommit:
        try {
          deleter.decRef(filesToCommit);
        } finally {
          filesToCommit = null;
          pendingCommit = null;
          notifyAll();
        }
      }

      if (infoStream.isEnabled("IW")) {
        infoStream.message("IW", String.format(Locale.ROOT, "commit: took %.1f msec", (System.nanoTime()-startCommitTime)/1000000.0));
      }
      
    } else {
      if (infoStream.isEnabled("IW")) {
        infoStream.message("IW", "commit: pendingCommit == null; skip");
      }
    }

    if (infoStream.isEnabled("IW")) {
      infoStream.message("IW", "commit: done");
    }
  }


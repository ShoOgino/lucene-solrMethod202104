  /**
   * Adds an offset correction mapping at the given output stream offset.
   *
   * <p>Assumption: the offset given with each successive call to this method will not be smaller
   * than the offset given at the previous invocation.
   *
   * @param off The output stream offset at which to apply the correction
   * @param cumulativeDiff The input offset is given by adding this to the output offset
   */
  protected void addOffCorrectMap(int off, int cumulativeDiff) {
    if (offsets == null) {
      offsets = new int[64];
      diffs = new int[64];
    } else if (size == offsets.length) {
      offsets = ArrayUtil.grow(offsets);
      diffs = ArrayUtil.grow(diffs);
    }

    assert (size == 0 || off >= offsets[size - 1])
        : "Offset #"
            + size
            + "("
            + off
            + ") is less than the last recorded offset "
            + offsets[size - 1]
            + "\n"
            + Arrays.toString(offsets)
            + "\n"
            + Arrays.toString(diffs);

    if (size == 0 || off != offsets[size - 1]) {
      offsets[size] = off;
      diffs[size++] = cumulativeDiff;
    } else { // Overwrite the diff at the last recorded offset
      diffs[size - 1] = cumulativeDiff;
    }
  }


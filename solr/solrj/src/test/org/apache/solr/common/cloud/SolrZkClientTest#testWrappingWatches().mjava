  @Test
  // SOLR-13491
  public void testWrappingWatches() throws Exception {
    AtomicInteger calls = new AtomicInteger(0);
    Semaphore semA = new Semaphore(0);
    Semaphore semB = new Semaphore(0);
    Watcher watcherA = new Watcher() {
      @Override
      public void process(WatchedEvent event) {
        calls.getAndIncrement();
        semA.release();
      }
    };
    Watcher watcherB = new Watcher() {
      @Override
      public void process(WatchedEvent event) {
        calls.getAndDecrement();
        semB.release();
      }
    };
    Watcher wrapped1A = defaultClient.wrapWatcher(watcherA);
    Watcher wrapped2A = defaultClient.wrapWatcher(watcherA);
    Watcher wrappedB = defaultClient.wrapWatcher(watcherB);
    assertTrue(wrapped1A.equals(wrapped2A));
    assertTrue(wrapped2A.equals(wrapped1A));
    assertFalse(wrapped1A.equals(wrappedB));
    assertEquals(wrapped1A.hashCode(), wrapped2A.hashCode());

    CollectionAdminRequest.createCollection(getSaferTestName(), "_default", 1, 1)
        .process(solrClient);

    CollectionAdminRequest.setCollectionProperty(getSaferTestName(),"foo", "bar")
        .process(solrClient);

    //Thread.sleep(600000);

    solrClient.getZkStateReader().getZkClient().getData("/collections/" + getSaferTestName() + "/collectionprops.json",wrapped1A, null,true);
    solrClient.getZkStateReader().getZkClient().getData("/collections/" + getSaferTestName() + "/collectionprops.json",wrapped2A, null,true);

    CollectionAdminRequest.setCollectionProperty(getSaferTestName(),"baz", "bam")
        .process(solrClient);

    assertTrue("Watch A didn't trigger", semA.tryAcquire(5, TimeUnit.SECONDS));
    if (TEST_NIGHTLY) {
      // give more time in nightly tests to ensure no extra watch calls
      Thread.sleep(500);
    }
    assertEquals(1, calls.get()); // same wrapped watch set twice, only invoked once

    solrClient.getZkStateReader().getZkClient().getData("/collections/" + getSaferTestName() + "/collectionprops.json",wrapped1A, null,true);
    solrClient.getZkStateReader().getZkClient().getData("/collections/" + getSaferTestName() + "/collectionprops.json",wrappedB, null,true);

    CollectionAdminRequest.setCollectionProperty(getSaferTestName(),"baz", "bang")
        .process(solrClient);

    assertTrue("Watch A didn't trigger", semA.tryAcquire(5, TimeUnit.SECONDS));
    assertTrue("Watch B didn't trigger", semB.tryAcquire(5, TimeUnit.SECONDS));
    if (TEST_NIGHTLY) {
      // give more time in nightly tests to ensure no extra watch calls
      Thread.sleep(500);
    }
    assertEquals(1, calls.get()); // offsetting watches, no change
  }


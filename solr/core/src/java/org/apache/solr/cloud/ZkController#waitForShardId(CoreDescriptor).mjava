  private void waitForShardId(final CoreDescriptor cd) {
    if (log.isDebugEnabled()) {
      log.debug("waiting to find shard id in clusterstate for {}", cd.getName());
    }
    try {
      DocCollection collection = zkStateReader.waitForState(cd.getCollectionName(), 320, TimeUnit.SECONDS,
        c -> c != null && c.getShardId(getNodeName(), cd.getName()) != null);
      // Read outside of the predicate to avoid multiple potential writes
      cd.getCloudDescriptor().setShardId(collection.getShardId(getNodeName(), cd.getName()));
    } catch (TimeoutException | InterruptedException e) {
      SolrZkClient.checkInterrupted(e);
      throw new SolrException(ErrorCode.SERVER_ERROR, "Failed getting shard id for core: " + cd.getName(), e);
    }
  }


  public void testPerReplicaStateCollection() throws Exception {
    CollectionAdminRequest.createCollection("versions_collection", "conf", 2, 1)
        .process(cluster.getSolrClient());

    String testCollection = "perReplicaState_test";
    int liveNodes = cluster.getJettySolrRunners().size();
    CollectionAdminRequest.createCollection(testCollection, "conf", 2, 2)
        .setPerReplicaState(Boolean.TRUE)
        .process(cluster.getSolrClient());
    cluster.waitForActiveCollection(testCollection, 2, 4);
    final SolrClient clientUnderTest = getRandomClient();
    final SolrPingResponse response = clientUnderTest.ping(testCollection);
    assertEquals("This should be OK", 0, response.getStatus());
    DocCollection c = cluster.getSolrClient().getZkStateReader().getCollection(testCollection);
    c.forEachReplica((s, replica) -> assertNotNull(replica.getReplicaState()));
    PerReplicaStates prs = PerReplicaStates.fetch(ZkStateReader.getCollectionPath(testCollection), cluster.getZkClient(), null);
    assertEquals(4, prs.states.size());

    // Now let's do an add replica
    CollectionAdminRequest
        .addReplicaToShard(testCollection, "shard1")
        .process(cluster.getSolrClient());
    prs = PerReplicaStates.fetch(ZkStateReader.getCollectionPath(testCollection), cluster.getZkClient(), null);
    assertEquals(5, prs.states.size());

    testCollection = "perReplicaState_testv2";
    new V2Request.Builder("/collections")
        .withMethod(POST)
        .withPayload("{create: {name: perReplicaState_testv2, config : conf, numShards : 2, nrtReplicas : 2, perReplicaState : true}}")
        .build()
        .process(cluster.getSolrClient());
    cluster.waitForActiveCollection(testCollection, 2, 4);
    c = cluster.getSolrClient().getZkStateReader().getCollection(testCollection);
    c.forEachReplica((s, replica) -> assertNotNull(replica.getReplicaState()));
    prs = PerReplicaStates.fetch(ZkStateReader.getCollectionPath(testCollection), cluster.getZkClient(), null);
    assertEquals(4, prs.states.size());
  }


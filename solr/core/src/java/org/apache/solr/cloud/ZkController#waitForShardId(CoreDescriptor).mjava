  private void waitForShardId(final CoreDescriptor cd) {
    if (log.isDebugEnabled()) {
      log.debug("waiting to find shard id in clusterstate for {}", cd.getName());
    }
    try {
      zkStateReader.waitForState(cd.getCollectionName(), 320, TimeUnit.SECONDS, c -> {
        if (c == null) return false;
        final String shardId = c.getShardId(getNodeName(), cd.getName());
        if (shardId != null) {
          cd.getCloudDescriptor().setShardId(shardId);
          return true;
        }
        return false;
      });
    } catch (TimeoutException | InterruptedException e) {
      SolrZkClient.checkInterrupted(e);
      throw new SolrException(ErrorCode.SERVER_ERROR, "Failed getting shard id for core: " + cd.getName(), e);
    }
  }


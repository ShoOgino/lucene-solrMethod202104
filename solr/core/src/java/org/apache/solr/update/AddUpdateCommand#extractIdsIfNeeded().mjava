  private void extractIdsIfNeeded() {
    if (indexedId != null) {
      return;
    }
    IndexSchema schema = req.getSchema();
    SchemaField sf = schema.getUniqueKeyField();
    if (sf != null) {
      if (solrDoc != null) {
        SolrInputField field = solrDoc.getField(sf.getName());
        // check some uniqueKey constraints
        int count = field==null ? 0 : field.getValueCount();
        if (count == 0) {
          if (overwrite) {
            throw new SolrException( SolrException.ErrorCode.BAD_REQUEST,"Document is missing mandatory uniqueKey field: " + sf.getName());
          }
        } else if (count  > 1) {
          throw new SolrException( SolrException.ErrorCode.BAD_REQUEST,"Document contains multiple values for uniqueKey field: " + field);
        } else {
          this.childDocIdStr = field.getFirstValue().toString();
          // the root might be in _root_ field or _route_ param.  If neither, then uniqueKeyField.
          this.indexedIdStr = (String) solrDoc.getFieldValue(IndexSchema.ROOT_FIELD_NAME); // or here
          if (this.indexedIdStr == null) {
            this.indexedIdStr = useRouteAsRoot;
            if (this.indexedIdStr == null) {
              this.indexedIdStr = childDocIdStr;
            }
          }
          indexedId = schema.indexableUniqueKey(indexedIdStr);
        }
      }
    }
  }


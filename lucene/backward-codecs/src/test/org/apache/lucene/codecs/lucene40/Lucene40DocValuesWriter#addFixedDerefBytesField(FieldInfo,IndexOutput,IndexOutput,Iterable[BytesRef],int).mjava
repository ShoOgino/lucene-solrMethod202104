  private void addFixedDerefBytesField(FieldInfo field, IndexOutput data, IndexOutput index, Iterable<BytesRef> values, int length) throws IOException {
    field.putAttribute(legacyKey, LegacyDocValuesType.BYTES_FIXED_DEREF.name());

    CodecUtil.writeHeader(data, 
                          Lucene40DocValuesFormat.BYTES_FIXED_DEREF_CODEC_NAME_DAT,
                          Lucene40DocValuesFormat.BYTES_FIXED_DEREF_VERSION_CURRENT);
    
    CodecUtil.writeHeader(index, 
                          Lucene40DocValuesFormat.BYTES_FIXED_DEREF_CODEC_NAME_IDX,
                          Lucene40DocValuesFormat.BYTES_FIXED_DEREF_VERSION_CURRENT);
    
    // deduplicate
    TreeSet<BytesRef> dictionary = new TreeSet<>();
    for (BytesRef v : values) {
      dictionary.add(v == null ? new BytesRef() : BytesRef.deepCopyOf(v));
    }
    
    /* values */
    data.writeInt(length);
    for (BytesRef v : dictionary) {
      data.writeBytes(v.bytes, v.offset, v.length);
    }
    
    /* ordinals */
    int valueCount = dictionary.size();
    assert valueCount > 0;
    index.writeInt(valueCount);
    final int maxDoc = state.segmentInfo.getDocCount();
    final PackedInts.Writer w = PackedInts.getWriter(index, maxDoc, PackedInts.bitsRequired(valueCount-1), PackedInts.DEFAULT);

    for (BytesRef v : values) {
      if (v == null) {
        v = new BytesRef();
      }
      int ord = dictionary.headSet(v).size();
      w.add(ord);
    }
    w.finish();
  }


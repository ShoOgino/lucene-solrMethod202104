  public void testOptimizeTopLevelClauseOrNull() throws IOException {
    // When there is a single non-null scorer, this scorer should be used
    // directly
    Directory dir = newDirectory();
    RandomIndexWriter w = new RandomIndexWriter(random(), dir);
    Document doc = new Document();
    doc.add(new StringField("foo", "bar", Store.NO));
    w.addDocument(doc);
    IndexReader reader = w.getReader();
    IndexSearcher searcher = new IndexSearcher(reader);
    searcher.setQueryCache(null); // so that weights are not wrapped
    final LeafReaderContext ctx = reader.leaves().get(0);
    Query query = new BooleanQuery.Builder()
      .add(new TermQuery(new Term("foo", "bar")), Occur.SHOULD) // existing term
      .add(new TermQuery(new Term("foo", "baz")), Occur.SHOULD) // missing term
      .build();

    // no scores -> term scorer
    Weight weight = searcher.createNormalizedWeight(query, false);
    BulkScorer scorer = ((BooleanWeight) weight).booleanScorer(ctx);
    assertTrue(scorer instanceof DefaultBulkScorer); // term scorer

    // disabled coords -> term scorer
    query = new BooleanQuery.Builder()
      .add(new TermQuery(new Term("foo", "bar")), Occur.SHOULD) // existing term
      .add(new TermQuery(new Term("foo", "baz")), Occur.SHOULD) // missing term
      .setDisableCoord(true)
      .build();
    weight = searcher.createNormalizedWeight(query, true);
    scorer = ((BooleanWeight) weight).booleanScorer(ctx);
    assertTrue(scorer instanceof DefaultBulkScorer); // term scorer

    // enabled coords -> BoostedBulkScorer
    searcher.setSimilarity(new ClassicSimilarity());
    query = new BooleanQuery.Builder()
      .add(new TermQuery(new Term("foo", "bar")), Occur.SHOULD) // existing term
      .add(new TermQuery(new Term("foo", "baz")), Occur.SHOULD) // missing term
      .build();
    weight = searcher.createNormalizedWeight(query, true);
    scorer = ((BooleanWeight) weight).booleanScorer(ctx);
    assertTrue(scorer instanceof BooleanTopLevelScorers.BoostedBulkScorer);

    w.close();
    reader.close();
    dir.close();
  }


  public AddUpdateCommand(SolrQueryRequest req) {
    super(req);

    // Populate useRouteParamAsIndexedId.
    // This ought to be deprecated functionality that we remove in 9.0. SOLR-15064
    String route = null;
    if (req != null) { // some tests use no req
      route = req.getParams().get(ShardParams._ROUTE_);
      if (route == null || !req.getSchema().isUsableForChildDocs()) {
        route = null;
      } else {
        // use route but there's one last exclusion: It's incompatible with SolrCloud implicit router.
        String collectionName = req.getCore().getCoreDescriptor().getCollectionName();
        if (collectionName != null) {
          DocRouter router = req.getCore().getCoreContainer().getZkController().getClusterState()
              .getCollection(collectionName).getRouter();
          if (router instanceof ImplicitDocRouter) {
            route = null;
          }
        }
      }
    }
    useRouteAsRoot = route;
  }


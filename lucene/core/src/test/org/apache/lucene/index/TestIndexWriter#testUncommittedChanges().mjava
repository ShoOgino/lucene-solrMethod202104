  public void testUncommittedChanges() throws IOException {
    Directory dir = newDirectory();
    // If version is < 50 IW.close should throw an exception
    // on uncommitted changes:
    IndexWriterConfig iwc = newIndexWriterConfig(random(), Version.LUCENE_4_8, new MockAnalyzer(random()));
    IndexWriter w = new IndexWriter(dir, iwc);
    Document doc = new Document();
    doc.add(new SortedDocValuesField("dv", new BytesRef("foo!")));
    w.addDocument(doc);
    try {
      w.close();
      fail("didn't hit exception");
    } catch (RuntimeException re) {
      // expected
      assertTrue(re.getMessage().contains("this writer is closed, but some pending changes or running merges were discarded"));
    }
    w.rollback();
    dir.close();
  }


  Map<String, Replica> waitToSeeReplicasInState(String collectionName, Collection<String> coreNames) throws InterruptedException {
    assert coreNames.size() > 0;
    Map<String, Replica> results = new ConcurrentHashMap<>();

    long maxWait = Long.getLong("solr.waitToSeeReplicasInStateTimeoutSeconds", 120); // could be a big cluster
    try {
      zkStateReader.waitForState(collectionName, maxWait, TimeUnit.SECONDS, c -> {
        if (c == null) return false;

        // We write into a ConcurrentHashMap, which will be ok if called multiple times by multiple threads
        c.getSlices().stream().flatMap(slice -> slice.getReplicas().stream())
            .filter(r -> coreNames.contains(r.getCoreName()))       // Only the elements that were asked for...
            .forEach(r -> results.putIfAbsent(r.getCoreName(), r)); // ...get added to the map

        log.debug("Expecting {} cores, found {}", coreNames, results);
        return results.size() == coreNames.size();
      });
    } catch (TimeoutException e) {
      throw new SolrException(ErrorCode.SERVER_ERROR, e.getMessage(), e);
    }

    return results;
  }


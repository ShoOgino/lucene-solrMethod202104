  @Test
  public void testOnlyRepresentativeIsVisibleWhenCollapsing() throws Exception {
    try {
      init("schema12.xml");
      assertU(adoc("id", "1", "title", "ZZZZ", "str_s1", "a"));
      assertU(adoc("id", "2", "title", "ZZZZ", "str_s1", "b"));
      assertU(adoc("id", "3", "title", "ZZZZ ZZZZ", "str_s1", "a"));
      assertU(adoc("id", "4", "title", "ZZZZ ZZZZ", "str_s1", "c"));

      assertU(commit());

      // default behaviour - all elevated docs are visible
      assertQ("", req(
              CommonParams.Q, "ZZZZ",
              CommonParams.QT, "/elevate",
              CollapsingQParserPlugin.COLLECT_ELEVATED_DOCS_WHEN_COLLAPSING, "true",
              CommonParams.FQ, "{!collapse field=str_s1 sort='score desc'}",
              CommonParams.FL, "id, score, [elevated]"),
              "//*[@numFound='4']",
              "//result/doc[1]/str[@name='id'][.='1']",
              "//result/doc[2]/str[@name='id'][.='2']",
              "//result/doc[3]/str[@name='id'][.='3']",
              "//result/doc[4]/str[@name='id'][.='4']",
              "//result/doc[1]/bool[@name='[elevated]'][.='true']",
              "//result/doc[2]/bool[@name='[elevated]'][.='true']",
              "//result/doc[3]/bool[@name='[elevated]'][.='true']",
              "//result/doc[4]/bool[@name='[elevated]'][.='false']"
      );

      // only representative elevated doc visible
      assertQ("", req(
              CommonParams.Q, "ZZZZ",
              CommonParams.QT, "/elevate",
              CollapsingQParserPlugin.COLLECT_ELEVATED_DOCS_WHEN_COLLAPSING, "false",
              CommonParams.FQ, "{!collapse field=str_s1 sort='score desc'}",
              CommonParams.FL, "id, score, [elevated]"),
              "//*[@numFound='3']",
              "//result/doc[1]/str[@name='id'][.='2']",
              "//result/doc[2]/str[@name='id'][.='3']",
              "//result/doc[3]/str[@name='id'][.='4']",
              "//result/doc[1]/bool[@name='[elevated]'][.='true']",
              "//result/doc[2]/bool[@name='[elevated]'][.='true']",
              "//result/doc[3]/bool[@name='[elevated]'][.='false']"
      );

    } finally {
      delete();
    }
  }


  boolean doStem(
      char[] word,
      int offset,
      int length,
      WordCase originalCase,
      WordContext context,
      RootProcessor processor) {
    IntsRef forms = dictionary.lookupWord(word, offset, length);
    if (forms != null) {
      for (int i = 0; i < forms.length; i += formStep) {
        char[] wordFlags = dictionary.decodeFlags(forms.ints[forms.offset + i], scratch);
        if (!acceptCase(originalCase, wordFlags, word, offset, length)) {
          continue;
        }
        // we can't add this form, it's a pseudostem requiring an affix
        if (Dictionary.hasFlag(wordFlags, dictionary.needaffix)) {
          continue;
        }
        // we can't add this form, it only belongs inside a compound word
        if (!context.isCompound() && Dictionary.hasFlag(wordFlags, dictionary.onlyincompound)) {
          continue;
        }
        if (context.isCompound()) {
          if (context != WordContext.COMPOUND_END
              && Dictionary.hasFlag(wordFlags, dictionary.compoundForbid)) {
            return false;
          }
          if (!Dictionary.hasFlag(wordFlags, dictionary.compoundFlag)
              && !Dictionary.hasFlag(wordFlags, context.requiredFlag(dictionary))) {
            continue;
          }
        }
        if (!processor.processRoot(new CharsRef(word, offset, length), forms, i)) {
          return false;
        }
      }
    }
    try {
      return stem(
          word,
          offset,
          length,
          context,
          -1,
          Dictionary.FLAG_UNSET,
          -1,
          0,
          true,
          true,
          false,
          false,
          originalCase,
          processor);
    } catch (IOException bogus) {
      throw new RuntimeException(bogus);
    }
  }


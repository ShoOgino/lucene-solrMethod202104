  /**
   * Pauses all update requests to this core and waits (indefinitely) for all in-flight
   * update requests to finish
   */
  public void pauseUpdatesAndAwaitInflightRequests() throws TimeoutException, InterruptedException {
    if (pauseUpdateRequests.compareAndSet(false, true)) {
      int arrivalNumber = inflightUpdatesCounter.register();
      assert arrivalNumber >= 0 : "Registration of in-flight request should have succeeded but got arrival phase number < 0";
      inflightUpdatesCounter.awaitAdvanceInterruptibly(inflightUpdatesCounter.arrive(), PAUSE_UPDATES_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS);
    }
  }


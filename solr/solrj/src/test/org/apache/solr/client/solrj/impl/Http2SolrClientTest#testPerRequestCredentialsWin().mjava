  @Test
  public void testPerRequestCredentialsWin() {
    try (Http2SolrClient client = new Http2SolrClient.Builder(jetty.getBaseUrl().toString() + "/debug/foo")
            .withBasicAuthCredentials("foo2", "explicit").build();) {
      QueryRequest r = new QueryRequest(new SolrQuery("quick brown fox"));
      r.setBasicAuthCredentials("foo3", "per-request");
      try {
        ignoreException("Error from server");
        client.request(r);
      } catch (Exception e) {
        // expected
      }
      unIgnoreException("Error from server");
      assertTrue(DebugServlet.headers.size() > 0);
      String authorizationHeader = DebugServlet.headers.get("authorization");
      assertNotNull("No authorization information in headers found. Headers: " + DebugServlet.headers, authorizationHeader);
      assertEquals("Basic " + Base64.byteArrayToBase64("foo3:per-request".getBytes(StandardCharsets.UTF_8)),  authorizationHeader);
    } finally {
      System.clearProperty("basicauth");
    }
  }


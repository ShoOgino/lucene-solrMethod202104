  public String applyTemplate(final Matcher matched) {
    String keySelector = matched.group("KEYSELECTOR");
    if (keySelector == null) keySelector = "";

    String unique = matched.group("UNIQUE");
    unique = unique != null ? unique.trim() : "";

    String type = matched.group("TYPE");
    if (type == null) {
      type = defaultType;
    }

    String metric = matched.group("METRIC");
    if (metric == null) {
      metric = unique;
    }

    // could be a simple field name or some kind of function here
    if (!metric.contains("$")) {
      if ("object.value".equals(metric)) {
        metric = "$object.value"; // don't require the user to supply the $
      } else if (!metric.contains("$object")) {
        if (Character.isDigit(metric.charAt(0))) {
          // jq doesn't like fields that start with a number
          metric = "$object.value[\"" + metric + "\"]";
        } else {
          // just a simple field reference in the value object
          metric = "$object.value." + metric;
        }
      } // else some kind of function, pass thru as-is
    } // else there's a $ so just assume it is a fully qualified reference to the desired value, leave as-is

    return template
        .replace("{UNIQUE}", unique)
        .replace("{KEYSELECTOR}", keySelector.trim())
        .replace("{METRIC}", metric.trim())
        .replace("{TYPE}", type.trim());
  }


  private void implTestReranking(boolean doFilter, boolean doSort, int getDocSetFlag, Float fixedScore) throws Exception {
    h.getCore().withSearcher(searcher -> {

      final QueryCommand cmd = new QueryCommand();
      cmd.setFlags(SolrIndexSearcher.GET_SCORES | getDocSetFlag);

      if (doSort) {
        cmd.setSort(new Sort(SortField.FIELD_SCORE, new SortField("id", SortField.Type.STRING)));
      }

      if (doFilter) {
        cmd.setFilterList(new TermQuery(new Term("field4_t", Integer.toString(NUM_DOCS - 1))));
      }

      cmd.setQuery(new TermQuery(new Term("field1_s", "foo")));

      final float expectedScore;
      if (fixedScore == null) {
        expectedScore = 1f;
      } else {
        expectedScore = fixedScore.floatValue();
        cmd.setQuery(new FixedScoreReRankQuery(cmd.getQuery(), expectedScore));
      }

      final QueryResult qr = new QueryResult();
      searcher.search(qr, cmd);

      // check score for the first document
      final DocIterator iter = qr.getDocList().iterator();
      iter.next();
      assertEquals(expectedScore, iter.score(), 0);

      return null;
    });

  }


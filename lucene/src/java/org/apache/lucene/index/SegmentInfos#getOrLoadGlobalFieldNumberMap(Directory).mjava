  /**
   * Loads or returns the already loaded the global field number map for this {@link SegmentInfos}.
   * If this {@link SegmentInfos} has no global field number map the returned instance is empty
   */
  synchronized FieldNumberBiMap getOrLoadGlobalFieldNumberMap(Directory dir) throws IOException {
    if (globalFieldNumberMap != null) {
      return globalFieldNumberMap;
    }
    final FieldNumberBiMap map  = new FieldNumberBiMap();
    
    if (lastGlobalFieldMapVersion > 0) {
      // if we don't have a global map or this is a SI from a earlier version we just return the empty map;
      readGlobalFieldMap(map, dir);
    }
    if (size() > 0) {
      if (format > DefaultSegmentInfosWriter.FORMAT_4_0) {
        assert lastGlobalFieldMapVersion == 0;
        // build the map up if we open a pre 4.0 index
        for (SegmentInfo info : this) {
          final FieldInfos segFieldInfos = info.getFieldInfos();
          for (FieldInfo fi : segFieldInfos) {
            map.addOrGet(fi.name, fi.number);
          }
        }
      }
    }
    return globalFieldNumberMap = map;
  }

